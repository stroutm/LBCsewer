## Load-Balancing Control for Distributed Sewer Assets
### Balancing water quality and flows in combined sewer systems using real-time control
Sara C. Troutman, Nancy G. Love, Branko Kerkez

Publication DOI: [10.1039/C9EW00882A](https://doi.org/10.1039/C9EW00882A)

A new generation of smart and connected stormwater and sewer systems is being enabled by emerging wireless technologies and data algorithms. 
Stormwater and combined sewer systems can be autonomously controlled (gates, valves, pumps) to allocate storage and adapt to changing inputs. 
As a result, there is an opportunity to begin viewing the collection system as an extension of the Water Resource Recovery Facility (WRRF), whereby flows in the collection system are dynamically controlled to benefit downstream treatment. 
The dynamic control of collection system storage will allow peak flows to be minimized and solid loads to the plant to be tuned in response to real-time WRRF states as they relate to treatment operation and performance. 
To that end, this paper presents a formulation of a real-time load-balancing algorithm to control distributed storage assets in the collection system, with objectives of improving flow and water quality dynamics at inflow to a treatment plant. 
We illustrate that this load-balancing approach can successfully attenuate wet-weather peaks and minimize dry-weather oscillations. 
The parameterization of the control algorithm is assessed in the context of competing objectives at the downstream WRRF and broader collection system (e.g. sediment loads, peak flows, flooding, and solids accumulation in the sewer system). 
By applying this control algorithm and analysis to an established case study, we identify a range of parameter values that provide most desirable performance across a number of system-wide objectives. 
Specifically, we discover a band of desirable performance, which not only improves inflow into the WRRF, but simultaneously reduces flooding and sedimentation in the collection system. 

<img src="https://github.com/stroutm/LBCsewer/blob/master/images/LBCsummary.png" alt="LBCsummary"/>

To use this algorithm, the following will have to be specified beforehand:

| Item | Symbol | Description |
|-----------|:-----------:|-----------|
| Set of sewer assets | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_i in I.png" alt="i \in I" height="16"/> | These can include e.g. storage basins with outlet valves and pump stations. |
| States | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si.png" alt="S_i" height="16"/> | This can be a vector of multiple states for each asset <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_i.png" alt="i" height="16"/> and can include items such as water level, pollutant concentration, and flow. |
| Setpoints | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si star.png" alt="S_i^*" height="16"/> | Setpoints are desired system conditions and must be specified for each state in <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si.png" alt="S_i" height="16"/>. |
| System importance values | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_alphai.png" alt="\alpha_i" height="10"/> | This can be used to specify which assets and states are most important within the system. The size of <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_alphai.png" alt="\alpha_i" height="10"/> must match <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si.png" alt="S_i" height="16"/>. |
| Instantaneous importance weight | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho.png" alt="\rho" height="16"/> | This parameter can be tuned to reflect how stressed an asset is at any given point in time. By analogy, <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho.png" alt="\rho" height="16"/> could encapsulate the comfort level of an operator (e.g., release proportional to water level vs. prioritize an asset only if it is close to full). For example, if storage capacity is used as an indicator of importance, with <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho1.png" alt="\rho = 1" height="16"/> the instantaneous importance of the asset increases nearly linearly with water level. With <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho100.png" alt="\rho = 100" height="16"/> the asset would be considered important only if it is close to capacity. See the graph in the above figure for further illustration of how <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_gammai.png" alt="\gamma_i" height="16"/> is impacted by state <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si.png" alt="S_i" height="16"/> for different values of <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho.png" alt="\rho" height="16"/>. |
| Set of controllable assets | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_IC.png" alt="I_C" height="16"/> | This set should contain all sewer storage assets in <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_I set.png" alt="I" height="16"/> that are controllable by the operator or system. This algorithm will inform control actions for these assets. |
| Set of uncontrollable assets | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_IU.png" alt="I_U" height="16"/> | This set should contain all sewer storage assets in <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_I set.png" alt="I" height="16"/> that will remain uncontrolled or are passively controlled. An example of what this set might contain is the inlet at the downstream WRRF with states pertaining to inflow conditions. Note: <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_I IC IU.png" alt="I_{C} \cup I_{U} = I" height="16"/> |

Then for each time step <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_t.png" alt="t" height="16"/>, the following are computed:

| Item | Symbol | Description |
|-----------|:-----------:|-----------|
| Instantaneous importance | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_gammai.png" alt="\gamma_i" height="16"/> | This is based on <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Si.png" alt="S_i" height="16"/> and <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_rho.png" alt="\rho" height="16"/>. In general, a higher state (e.g., water level) will result in a higher instantaneous importance. |
| Overall importance | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_betai.png" alt="\beta_i" height="16"/> | This is a product of the system importance and instantaneous importance of asset <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_i.png" alt="i" height="16"/>. |
| Importance-weighted average | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Cbar.png" alt="\bar{C}" height="16"/> | This provides a basis for which to compare the relative stress of all assets in the system and is used to determined which assets release water during a particular time step. |
| Set of assets to release water | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_J set.png" alt="J" height="16"/> | These assets must be controllable (<img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_J IC.png" alt="J \subseteq I_C" height="16"/>) and have an importance-weighted deviation that is greater than the average: asset <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_j.png" alt="j" height="16"/> such that <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_release.png" alt="\beta_j(t) \cdot \left( S_j(t) - S_j^*(t) \right) > \bar{C}(t)" height="16"/>. |
| Relative allotment factors | <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_Rj.png" alt="R_j" height="16"/> | This factor is computed for each asset that will release water, i.e. <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_j in J.png" alt="j \in J" height="16"/>. This allotment factor simply assigns the fraction of a downstream assetâ€™s capacity that will be allotted to an upstream asset <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_j.png" alt="j" height="16"/> and is defined as the importance-weighted deviation that is then normalized within set <img src="https://github.com/stroutm/LBCsewer/blob/master/images/eqn_J set.png" alt="J" height="16"/>. |

The relative allotment factor can then be multiplied by available downstream capacity at each time step to determine how much to release from each upstream storage asset.

The algorithm below summarizes this procedure step by step.

<img src="https://github.com/stroutm/LBCsewer/blob/master/images/algorithm.PNG" alt="algorithm" width="350"/>
